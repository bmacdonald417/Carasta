generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id           String    @id @default(cuid())
  email        String    @unique
  passwordHash String?
  handle       String    @unique
  name         String?
  bio          String?
  avatarUrl    String?
  location     String?
  image        String?
  emailVerified DateTime?
  accounts     Account[]
  sessions     Session[]
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  followers    Follow[]  @relation("Following")
  following    Follow[]  @relation("Follower")
  posts        Post[]
  likes        Like[]
  comments     Comment[]
  garageCars   GarageCar[]
  auctions     Auction[] @relation("Seller")
  bids         Bid[]
  autoBids     AutoBid[]
  notifications Notification[]
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token     String?
  expires_at       Int?
  token_type       String?
  scope            String?
  id_token         String?
  session_state    String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

model Follow {
  id          String   @id @default(cuid())
  followerId  String
  followingId String
  createdAt   DateTime @default(now())

  follower  User @relation("Follower", fields: [followerId], references: [id], onDelete: Cascade)
  following User @relation("Following", fields: [followingId], references: [id], onDelete: Cascade)

  @@unique([followerId, followingId])
  @@index([followerId])
  @@index([followingId])
}

model Post {
  id        String   @id @default(cuid())
  authorId  String
  content   String?
  imageUrl  String?
  createdAt DateTime @default(now())

  author   User     @relation(fields: [authorId], references: [id], onDelete: Cascade)
  likes    Like[]
  comments Comment[]

  @@index([authorId])
  @@index([createdAt])
}

model Like {
  userId String
  postId String
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  post Post @relation(fields: [postId], references: [id], onDelete: Cascade)

  @@id([userId, postId])
  @@index([postId])
}

model Comment {
  id        String   @id @default(cuid())
  postId    String
  authorId  String
  content   String
  createdAt DateTime @default(now())

  post   Post @relation(fields: [postId], references: [id], onDelete: Cascade)
  author User @relation(fields: [authorId], references: [id], onDelete: Cascade)

  @@index([postId])
}

model GarageCar {
  id        String   @id @default(cuid())
  ownerId   String
  type      String   // GARAGE | DREAM
  year      Int
  make      String
  model     String
  trim      String?
  notes     String?
  createdAt DateTime @default(now())

  owner  User            @relation(fields: [ownerId], references: [id], onDelete: Cascade)
  images GarageCarImage[]

  @@index([ownerId])
  @@index([ownerId, type])
}

model GarageCarImage {
  id          String   @id @default(cuid())
  garageCarId String
  url         String
  sortOrder   Int      @default(0)

  garageCar GarageCar @relation(fields: [garageCarId], references: [id], onDelete: Cascade)

  @@index([garageCarId])
}

model Auction {
  id                String    @id @default(cuid())
  sellerId          String
  title             String
  description       String?
  year              Int
  make              String
  model             String
  trim              String?
  vin               String?
  mileage           Int?
  reservePriceCents Int?
  buyNowPriceCents  Int?
  buyNowExpiresAt   DateTime?
  startAt           DateTime
  endAt             DateTime
  status            String    // DRAFT | LIVE | SOLD | ENDED
  createdAt         DateTime  @default(now())
  updatedAt        DateTime  @updatedAt

  seller  User          @relation("Seller", fields: [sellerId], references: [id], onDelete: Cascade)
  images  AuctionImage[]
  bids    Bid[]
  autoBids AutoBid[]

  @@index([sellerId])
  @@index([status])
  @@index([endAt])
  @@index([make, model, year])
}

model AuctionImage {
  id        String   @id @default(cuid())
  auctionId String
  url       String
  sortOrder Int      @default(0)

  auction Auction @relation(fields: [auctionId], references: [id], onDelete: Cascade)

  @@index([auctionId])
}

model Bid {
  id        String   @id @default(cuid())
  auctionId String
  bidderId  String
  amountCents Int
  createdAt DateTime @default(now())

  auction Auction @relation(fields: [auctionId], references: [id], onDelete: Cascade)
  bidder User     @relation(fields: [bidderId], references: [id], onDelete: Cascade)

  @@index([auctionId])
  @@index([bidderId])
}

model AutoBid {
  id            String   @id @default(cuid())
  auctionId     String
  bidderId      String
  maxAmountCents Int
  active        Boolean  @default(true)
  createdAt     DateTime @default(now())

  auction Auction @relation(fields: [auctionId], references: [id], onDelete: Cascade)
  bidder User     @relation(fields: [bidderId], references: [id], onDelete: Cascade)

  @@unique([auctionId, bidderId])
  @@index([auctionId])
}

model Notification {
  id         String    @id @default(cuid())
  userId     String
  type       String
  payloadJson String
  createdAt  DateTime  @default(now())
  readAt     DateTime?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}
